# module-face_recognition

采用InsightFace人脸识别模型和MTCNN人脸检测算法实现的人脸识别模块。实现以下功能：

* 单张图片人脸识别
* 视频人脸识别
* 课堂考勤系统

## 使用说明

### 预备：环境配置

本模块中的人脸识别功能代码需要使用NVIDIA GPU运行，请事先安装CUDA+CUDNN，并在虚拟环境中安装对应版本的支持GPU运算的mxnet（例如CUDA 10.2+CUDNN 8.2.0+mxnet-cu102），以及tensorflow、opencv等所需packet。

### 第一步：制作人脸识别数据库

**make_database.py**

创建包含已知人脸的数据库。所有人脸照片放在一个文件夹下。对于每个人需要给出其编号（关键字）、姓名和照片名称信息，输入到文本文件中。

输入参数：

* --db: 数据库名称。
* --create: 是否创建新数据库。设为>=1则可以创建新数据库，设为0则只能更新已有数据库的信息。
* --input-dir: 人脸照片所在文件夹。每张照片只能包含一张人脸。
* --input-text: 所有人的编号、姓名和照片名称（仅输入在"--input-dir"下的名称）。可在其中添加空行和以"#"开头的注释行。
* --image-size: 使用MTCNN对输入的人脸照片进行裁剪，得到的人脸缩略图的尺寸。默认缩略图尺寸为112 * 112。
* --exts: 人脸照片可选拓展名。默认包含.jpeg, .jpg, .png, .bmp格式。
* --encoding: 打开文本文件所使用的的编码。默认为utf-8。

### 第二步：运行人脸识别功能代码

利用已创建的人脸数据库实现各种人脸识别功能。

**注意：**运行以下人脸识别功能代码前，请事先从InsightFace的[Model-Zoo](https://github.com/deepinsight/insightface/wiki/Model-Zoo)下载所需的人脸识别模型，并放置在model/目录下。（如果你愿意，也可以根据InsightFace中训练人脸识别模型的步骤自行训练模型并使用之。）本项目默认使用Model-Zoo中的LResNet100E-IR,ArcFace@ms1m-refine-v2（model-r100-ii），若选用其他模型，请在config/config.py中修改model_name配置。

**单张图片人脸识别：image_recognition.py**

对给定单张图像进行人脸识别。

输入参数：

* --db: 已有数据库名称。
* --input: 要进行人脸识别的图片路径。
* --output-text: 输出的包含人脸识别结果信息（文本文件）的路径。包含识别出的人脸序号、人脸位置和人名。
* --output: 输出的人脸识别结果图片的路径。
* --dup-check: 是否进行人脸重复检查（若开启此检查，则识别结果中不会出现两张人脸对应同一人的情况，有助于提升真实环境下人脸识别的准确率；若关闭此检查，则对于输入图像中两张与数据库中某一人脸都高度相似的人脸，都识别为此人）。设为>=1则进行检查，设为0则不检查。
* --image-size: 使用MTCNN对输入的人脸照片进行裁剪，得到的人脸缩略图的尺寸。默认缩略图尺寸为112 * 112。
* --exts: 人脸照片可选拓展名。默认包含.jpeg, .jpg, .png, .bmp格式。
* --encoding: 打开文本文件所使用的的编码。默认为utf-8。

**视频人脸识别：video_recognition.py**

对本地视频文件或笔记本电脑的前置摄像头输入画面进行人脸识别。

输入参数：

* --db: 已有数据库名称。
* --camera: 是否从电脑前置摄像头输入视频。设为>=1则从前置摄像头输入，否则从本地文件输入。默认从本地文件输入。
* --input: 要进行人脸识别的本地视频路径。（仅当"--camera"设为>=1时有效）
* --save: 是否将识别结果保存至本地视频文件。设为>=1则保存。默认不保存。
* --output: 识别结果保存至本地视频文件的路径。（仅当"--save"设为>=1时有效）
* --dup-check: 是否进行人脸重复检查。设为>=1则进行检查，设为0则不检查。
* --image-size: 使用MTCNN对输入的人脸照片进行裁剪，得到的人脸缩略图的尺寸。默认缩略图尺寸为112 * 112。
* --encoding: 打开文本文件所使用的的编码。默认为utf-8。

运行video_recognition.py过程中，当你的电脑屏幕开始播放人脸识别结果画面时，可以随时按Q键结束视频人脸识别，退出程序。

**课堂考勤系统：attendance_system.py**

基于视频人脸识别的考勤系统。操作者可选择部分数据库中已知人员，使用相应数据库对其进行考勤。被考勤人员签到时只需持续在视频画面中出现一段时间，即可自动完成签到。考勤者可自由选择考勤时间段，系统自动记录每个考勤时间段的起止时间和这一时间段内签到的人员，并在需要时输出所有时间段的情况和此次考勤中所有人员出勤情况。

输入参数：

* --db: 已有数据库名称。
* --camera: 是否从电脑前置摄像头输入视频。设为>=1则从前置摄像头输入，否则从本地文件输入。默认从前置摄像头输入。
* --input: 要进行人脸识别的本地视频路径。（仅当"--camera"设为>=1时有效）
* --ckp-text: 被考勤人员编号名单。可在其中添加空行和以"#"开头的注释行。
* --check-res: 输出的考勤结果（文本文件）的路径。此结果中包含每个考勤时间段的起止时间和这一时间段内签到的人员，以及此次考勤中出勤人员和未出勤人员的名单。
* --save: 是否将识别结果保存至本地视频文件。设为>=1则保存。默认不保存。
* --output: 识别结果保存至本地视频文件的路径。（仅当"--save"设为>=1时有效）
* --dup-check: 是否进行人脸重复检查。设为>=1则进行检查，设为0则不检查。
* --image-size: 使用MTCNN对输入的人脸照片进行裁剪，得到的人脸缩略图的尺寸。默认缩略图尺寸为112 * 112。
* --encoding: 打开文本文件所使用的的编码。默认为utf-8。

运行attendance_system.py过程中，当你的电脑屏幕开始播放人脸识别结果画面时，需要利用以下功能键来实现各项系统功能：

* A: 按A键在普通人脸识别状态和考勤准备状态之间进行切换。系统打开时默认进入普通人脸识别状态，此状态下所有识别出的人脸在画面中使用蓝色方框框出；在考勤准备状态下，被考勤人员的人脸方框可能为橙色（未签到）和绿色（完成签到），无需考勤的人员仍使用蓝色方框框出人脸。

* Z: 在考勤准备状态下，按Z键进入考勤运行状态。考勤运行状态下，当未签到的被考勤人员进入画面时，其人脸方框变为金色（正在签到）。未签到人员在画面中持续出现10帧（约2-4秒）后即可完成签到，人脸方框变为绿色。

* X: 在考勤运行状态下，按X键返回考勤准备状态。

* W: 在考勤准备状态下，按W键将此次考勤的结果保存至"--check-res"指定的文本文件中。

* C: 在考勤准备状态下，按C键清空此次考勤的记录，即开始下一次考勤。

* V: 在普通人脸识别状态下，按V键切换是否进行人脸重复检查的设置。系统打开时默认采用"--dup-check"指定的人脸重复检查设置。

也可以随时按Q键结束视频人脸识别，退出程序。

